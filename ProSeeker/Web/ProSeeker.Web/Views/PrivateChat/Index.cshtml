@model ProSeeker.Web.ViewModels.PrivateChat.PrivateChatViewModel
@*<form class="chat-input" asp-controller="" asp-action="CreateMessage">*@

<p>@Model</p>
<form asp-controller="PrivateChat" asp-action="SendMessage">
    <div class="container">
        <div id="message-holder" class="mt-3 d-flex justify-content-start">
            <h4>Message</h4>
            <input class="w-75 ml-4 pl-3" name="message" type="text" id="messageInput" placeholder="Напиши..." />
            <button id="sendButton" class="ml-4 btn btn-dark btn-lg">Send</button>
        </div>
        <hr style="height: 5px;" class="bg-dark" />
        <div id="messagesList" style="font-size: 28px;">
        </div>
    </div>
    <input name="conversationId" asp-for="@Model.ConversationId" type="hidden" id="hConversationId" />
    <input name="senderId" asp-for="@Model.Sender.Id" type="hidden" id="hSenderId" />
    <input name="receiverId" asp-for="@Model.Receiver.Id" type="hidden" id="hReceiverId" />

    @*@await Component.InvokeAsync("PrivateChat",
        new
             {
            receiverId = Model.Receiver.Id,
            senderId = Model.Sender.Id,
            conversationId = Model.ConversationId
        })*@
</form>

@section Scripts{

    <script asp-append-version="true">
        var _connectionId = '';

        var connection =
            new signalR.HubConnectionBuilder()
                .withUrl('/chat')
                .build();

        connection.on("ReceiveMessage",
            function (message) {
                var chatInfo = `<div>[${message.user}] ${escapeHtml(message.text)}</div>`;
                $("#messagesList").append(chatInfo);
            });

            //$("#sendButton").click(function (event) {
            //    event.preventDefault();
            //    let senderId = $('#hSenderId').val();
            //    let receiverId = $('#hReceiverId').val();
            //    let conversationId = $('#hConversationId').val();
            //    debugger;
            //    var chatMessage = $("#messageInput").val();
            //    connection.invoke("Send", chatMessage, receiverId, senderId, conversationId);
            //    $("#messageInput").val("");

            });

        connection.start().catch(function (err) {
            // The only way to get the connection id is through the Hub so we invoke the method from here
            connection.invoke('getConnectionId')
                .then(function (connectionId) {
                    _connectionId = connectionId
                });
            return console.error(err.toString());
        });


        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
} 